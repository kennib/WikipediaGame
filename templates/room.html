<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/static/css/main.css">

<script src="/static/lib/mergeDeep.js"></script>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>

<script src="/static/timer.js"></script>
<link rel="stylesheet" href="/static/css/timer.css">

<script src="/static/enter_name.js"></script>
<script src="/static/waiting_room.js"></script>
<script src="/static/round_setup.js"></script>
<script src="/static/round_answer.js"></script>
<script src="/static/round_scores.js"></script>
<script src="/static/round.js"></script>
<script src="/static/final_scores.js"></script>

<div id="app">
  <header>
    <h1>Pickapedia</h1>
    <span class="player">{{ player }}</span>
    <span class="room">{{ room }}</span>
  </header>
  
  <div v-if="state == 'loading'">
    Loading...
  </div>
  <div v-if="state == 'enter name'">
    <enter-name v-bind:on-submit="enterName" />
  </div>
  <div v-if="state == 'waiting room'">
    <waiting-room
      v-bind:state="state"
      v-bind:room="room"
      v-bind:players="players" />
  </div>
  <div v-if="state == 'round' || state == 'round scores' || state == 'round setup'">
    <round
      v-bind:state="state"
      v-bind:room="room"
      v-bind:player="player"
      v-bind:round="round"
      v-bind:sync-time="syncTime"
     />
  </div>
  <div v-if="state == 'final scores'">
    <final-scores
      v-bind:results="results"
      v-bind:button-event="playAgain"
    >
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
var socket = io()

var app = new Vue({
  el: '#app',
  beforeCreate: function() {
    vm = this
    
    let url = new URL(window.location.href)
    let path = url.pathname.split('/')

    vm.room = path[path.length-1]

    let cookies = document.cookie.split('; ')
    let playerCookie = cookies.find(function(row) { return row.startsWith('player=') })

    vm.player = playerCookie.split('=')[1];
    
    if (!vm.player) {
      vm.state = 'enter name'
    } else {
      vm.state = 'loading'
    }

    socket.on('connect', function() {
      vm.join()
    })
    socket.on('new players', function(players) {
      console.log(players)
      vm.players = players
    })
    socket.on('disambiguation', function(disambiguation) {
      vm.round.submitted = false
      console.log(disambiguation)
      vm.round.disambiguation = disambiguation
    })
    socket.on('invalid answer', function(invalidAnswer) {
      vm.round.submitted = false
      console.log(invalidAnswer)
      vm.round.invalidAnswer = invalidAnswer.message
    })
    socket.on('update state', function(data) {
      console.log(data)
      for (let key in data) {
        vm[key] = data[key]
      }
      vm.$forceUpdate()
    })
    socket.on('partial update state', function(data) {
      mergeDeep(vm, data)
      vm.$forceUpdate()
    })
  },
  methods: {
    join: function() {
      let vm = this
      if (vm.player && vm.room) {
        socket.emit('join', {
          player: vm.player,
          room: vm.room,
        })
      }
    },
    enterName: function(player) {
      let url = new URL(window.location.href)
      url.searchParams.set('name', player)
      history.replaceState(null, null, "?"+url.searchParams.toString())

      this.player = player
      this.state = 'waiting room'
      this.join()
      this.$forceUpdate()
    },
    playAgain: function() {
      socket.emit('play again', { room: this.room })
    }
  },
  watch: {
    serverTime: function(serverTime) {
      let now = Math.floor(Date.now() / 1000)
      this.syncTime = serverTime - now
    }
  },
  data: function() {
    return {
      serverTime: Math.floor(Date.now() / 1000),
      players: [],
      round: {
        number: 0,
        time: 0,
        question: {
          description: '',
          data: {
          },
        },
        waitingFor: [],
        disambiguation: {
          word: '',
          options: [],
        },
        results: {},
      },
    }
  }
})
</script>


<script type="text/javascript" charset="utf-8">
</script>

<style>
  img {
    height: 40vh;
    width: auto;
  }
</style>