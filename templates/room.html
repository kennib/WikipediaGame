<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script src="/static/timer.js"></script>

<div id="app">
  <h1>Pickapedia</h1>
  <h2>{{ room }}</h2>
  <div v-if="state == 'loading'">
    Loading...
  </div>
  <div v-if="state == 'waiting room'">
    <h2>Players</h2>
    <ol>
      <li v-for="player in players" v-text="player"></li>
    </ol>
    <button v-on:click="nextRound">Start Game</button>
  </div>
  <div v-if="state == 'round setup'">
    <div v-if="playerChoice.player == player">
      Select an article
      <select v-model="playerSelection" v-on:change="submitPlayerChoice">
        <option></option>
        <option v-for="option in playerChoice.options" v-bind:value="option">
          {{ option }}
        </option>
      </select>
    </div>
    <div v-else>
      {{ playerChoice.player }} is choosing an article
    </div>
  </div>
  <div v-if="state == 'round'">
    <timer v-bind:count-down="roundTime"></timer>
    <h2>Round {{ round }}</h2>
    <h3 v-text="question.description"></h3>
    <img v-if="question.data.image" v-bind:src="question.data.image" />
    <div v-if="disambiguation">
      Which {{ disambiguation.word }} did you mean?
      <select v-model="answer" v-on:change="submitAnswer">
        <option></option>
        <option v-for="option in disambiguation.options" v-bind:value="option">
          {{ option }}
        </option>
      </select>
    </div>
    <div v-else-if="!submitted">
      <div v-if="invalidAnswer">
        {{ invalidAnswer }}
      </div>
      <input v-model="answer" v-on:keyup.enter="submitAnswer"></input>
      <button v-on:click="submitAnswer">Submit answer</button>
    </div>
    <div v-else>
      Waiting for
      <em v-if="waitingFor.length == 1">{{ waitingFor[0] }}</em>
      <em v-else>{{ waitingFor.length }} players</em>
      to enter an answer
    </div>
  </div>
  <div v-if="state == 'round scores'">
    <h2>Round {{ round }} - scores</h2>
    <h3 v-text="question.description"></h3>
    <img v-if="question.data.image" v-bind:src="question.data.image" />
    <div v-if="question.data.answer">
      <h4 v-if="question.data.answer.article">
        Article: 
        <span v-text="question.data.answer.article"></span>
      </h4>
      <h4 v-if="question.data.answer.articles">
        Answer:
        <span v-for="article in question.data.answer.articles">{{article}} </span>
      </h4>
    </div>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Answer</th>
          <th>Article</th>
          <th>{{ question.data.answer.scoreType }}</th>
          <th v-if="question.data.answer.example">Example</th>
          <th>Round Score</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="result in results">
          <td>{{ result.player }}</td>
          <td>{{ result.answer }}</td>
          <td>{{ result.article }}</td>
          <td>{{ result.raw_score }}</td>
          <th v-if="question.data.answer.example">{{ question.data.answer.example }}</th>
          <td>{{ result.normalised_score }}</td>
        </tr>
      </tbody>
    </table>
    <button v-on:click="nextRound">Next Round</button>
  </div>
  <div v-if="state == 'final scores'">
    <h2>Final scores</h2>
    <table>
      <thead>
        <tr>
          <th>Player</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(result, index) in results">
          <td>{{ result.player }}</td>
          <td>{{ result.score }}</td>
          <td v-if="index==0">Winner!</td>
        </tr>
      </tbody>
    </table>
    <button v-on:click="playAgain">Play again</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
<script type="text/javascript" charset="utf-8">
var socket = io()

var app = new Vue({
  el: '#app',
  beforeCreate: function() {
    vm = this
    var url = new URL(window.location.href)
    vm.room = url.searchParams.get('room')
    vm.player = url.searchParams.get('name')

    socket.on('connect', function() {
      socket.emit('join', {
        player: vm.player,
        room: vm.room,
      })
    })
    socket.on('new players', function(players) {
      console.log(players)
      vm.players = players
    })
    socket.on('disambiguation', function(disambiguation) {
      vm.submitted = false
      console.log(disambiguation)
      vm.disambiguation = disambiguation
    })
    socket.on('invalid answer', function(invalidAnswer) {
      vm.submitted = false
      console.log(invalidAnswer)
      vm.invalidAnswer = invalidAnswer.message
    })
    socket.on('update state', function(data) {
      console.log(data)
      for (let key in data) {
        vm[key] = data[key]
      }
    })
  },
  methods: {
    submitAnswer: function() {
      if (this.answer) {
        socket.emit('send answer', { room: this.room, player: this.player, answer: this.answer })
        this.submitted = true
      }
    },
    submitPlayerChoice: function() {
      socket.emit('send player choice', { room: this.room, choice: this.playerSelection })
    },
    nextRound: function() {
      socket.emit('next round', { room: this.room, state: this.state, round: this.round })
    },
    playAgain: function() {
      socket.emit('play again', { room: this.room })
    }
  },
  data: {
    players: [],
    state: 'loading',
    round: 0,
    roundTime: 0,
    question: {
      description: '',
      data: {
      },
    },
    answer: '',
    waitingFor: [],
    disambiguation: null,
    invalidAnswer: null,
    playerChoice: null,
    playerSelection: '',
    submitted: false,
    results: {}
  }
})
</script>


<script type="text/javascript" charset="utf-8">
</script>

<style>
  img {
    height: 40vh;
    width: auto;
  }
</style>